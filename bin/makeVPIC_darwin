#!/bin/bash

################################################################################
# Set some high level variables.

ARCH=$1

BRANCH=$2

NJ=$3

VPIC_ROOT=$PWD

export VPIC_DIR=$VPIC_ROOT/build/$ARCH/vpic

################################################################################
# Switch to the build directory and copy the VPIC source.  First check for the
# existence of an old VPIC directory and remove it if it does exist.

cd build

if [ -d $ARCH ]; then
  rm -rf $ARCH
fi

mkdir $ARCH
cd $ARCH

cp -R $VPIC_ROOT/src/branches/$BRANCH/vpic .

cd $VPIC_DIR

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_NONE_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_PORT_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_SSE_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers and OpenMPI.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_AVX2_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V8_PORT_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V8_AVX2_HSW" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2" \
    -DCMAKE_CXX_FLAGS="-g -O2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_NONE_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_PORT_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_SSE_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_AVX2_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V8_PORT_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V8_AVX2_HSW" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_NONE_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_PORT_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_SSE_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers and OpenMPI.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V4_AVX2_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V8_PORT_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_INT_OPT_V8_AVX2_KNL" ]; then
  module load intel/parallel_studio_xe_2017_beta_update1

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DCMAKE_C_COMPILER=mpiicc \
    -DCMAKE_CXX_COMPILER=mpiicpc \
    -DCMAKE_C_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O2 -xmic-avx512 -rdynamic -fp-model precise -fp-model source -parallel-source-info=2" \
    -DMPIEXEC=`which mpirun` \
    ..
  make VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_NONE_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_PORT_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_SSE_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V4_AVX2_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V8_PORT_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "DARWIN_MASTER_LINUX_GNU_OPT_V8_AVX2_KNL" ]; then
  module load gcc/6.1.0

  module list

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fno-unsafe-math-optimizations -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make VERBOSE=1
fi
