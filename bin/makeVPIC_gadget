#!/bin/bash

################################################################################
# Set some high level variables.

ARCH=$1

BRANCH=$2

NJ=$3

VPIC_ROOT=$PWD

export VPIC_DIR=$VPIC_ROOT/build/$ARCH/vpic

################################################################################
# Switch to the build directory and copy the VPIC source.  First check for the
# existence of an old VPIC directory and remove it if it does exist.

cd build

if [ -d $ARCH ]; then
  rm -rf $ARCH
fi

mkdir $ARCH
cd $ARCH

cp -R $VPIC_ROOT/src/branches/$BRANCH/vpic .

cd $VPIC_DIR

################################################################################
# Set some high level variables to control module versions.

VERSION_CMAKE=3.7.1
VERSION_INTEL=17.0.4
VERSION_CRAY=8.5.8
VERSION_GNU=6.3.0                      # Not implemented yet.
VERSION_CRAY_MPICH=7.5.4
VERSION_INTEL_PERF_TOOLS=2017.2.028
VERSION_CRAY_PERF_TOOLS=6.4.6

################################################################################
# Execute some module commands which apply to all ARCH values.

module unload craype-hugepages2M

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_HSW_HIO" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR
  export HIO_ROOT=/users/wdn/Projects/hio_project/build/GADGET_MASTER_INT_OPT_CRAYMPI/hio

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -DVPIC_USE_HIO -I$HIO_ROOT/include \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -DVPIC_USE_HIO -I$HIO_ROOT/include \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_EXE_LINKER_FLAGS="$HIO_ROOT/lib/libhio.a" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_PTH_INT_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_PTH_GNU_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_PTH_CCE_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=OFF \
    -DUSE_PTHREADS=ON \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_AVEC_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DUSE_ADVANCE_P_AUTOVEC=YES \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -no-ansi-alias" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -no-ansi-alias" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_HSW" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_AVEC_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DUSE_ADVANCE_P_AUTOVEC=YES \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_AVX512_KNL" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_HSW_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_AVX512_KNL_CPAT" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_HSW_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_AVX512_KNL_CPAT_LITE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load perftools-base
  module swap perftools-base perftools-base/$VERSION_CRAY_PERF_TOOLS
  module load perftools-lite

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=OFF \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_HSW_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Intel compilers.

if [ $ARCH = "GADGET_OMP_INT_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap intel intel/$VERSION_INTEL
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                     -qopt-report=5 -qopt-report-phase=all -Winline \
                     -qoverride-limits -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                     -debug inline-debug-info -parallel-source-info=2" \
    -DCMAKE_CXX_FLAGS="-g -O3 -inline-forceinline -vec-threshold0 \
                       -qopt-report=5 -qopt-report-phase=all -Winline \
                       -qoverride-limits -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include \
                       -debug inline-debug-info -parallel-source-info=2" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                     -fno-strict-aliasing -fomit-frame-pointer \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -msse -ffast-math -fno-unsafe-math-optimizations \
                       -fno-strict-aliasing -fomit-frame-pointer \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with GNU compilers.

if [ $ARCH = "GADGET_OMP_GNU_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-gnu
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                     -fno-unsafe-math-optimizations -fno-strict-aliasing \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -mavx2 -mavx -mfma -ffast-math -fomit-frame-pointer \
                       -fno-unsafe-math-optimizations -fno-strict-aliasing \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################################################################################################

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_NONE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_SSE_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_SSE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V4_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V8_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V8_AVX2_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V8_AVX2=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_PORT_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_PORTABLE=ON \
    -DUSE_V16_PORTABLE=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi

################################################################################
# Build an optimized version of VPIC with Cray compilers.

if [ $ARCH = "GADGET_OMP_CCE_OPT_V16_AVX512_KNL_VTUNE" ]; then
  module load friendly-testing
  module load sandbox
  module load cmake
  module swap cmake cmake/$VERSION_CMAKE
  module swap PrgEnv-intel PrgEnv-cray
  module swap cce cce/$VERSION_CRAY
  module swap craype-haswell craype-mic-knl
  module swap cray-mpich cray-mpich/$VERSION_CRAY_MPICH
  module load intel-performance-tools
  module swap intel-performance-tools intel-performance-tools/$VERSION_INTEL_PERF_TOOLS

  module list

  export MPI_ROOT=$MPICH_DIR

  cd $VPIC_DIR
  mkdir build
  cd build
  cmake \
    -LAH \
    -DCMAKE_BUILD_TYPE=None \
    -DBUILD_SHARED_LIBS=ON \
    -DCMAKE_BUILD_WITH_INSTALL_RPATH=$VPIC_DIR/build/lib \
    -DENABLE_COLOR_UNIT_TESTS=ON \
    -DENABLE_INTEGRATED_TESTS=ON \
    -DENABLE_UNIT_TESTS=ON \
    -DUSE_V4_AVX2=ON \
    -DUSE_V16_AVX512=ON \
    -DVPIC_PRINT_MORE_DIGITS=ON \
    -DUSE_OPENMP=ON \
    -DUSE_PTHREADS=OFF \
    -DCMAKE_C_COMPILER=cc \
    -DCMAKE_CXX_COMPILER=CC \
    -DCMAKE_C_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                     -DVPIC_USE_VTUNE_OFF \
                     -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    -DCMAKE_CXX_FLAGS="-O2 -hlist=ad -hipa5 -rdynamic -dynamic -craype-verbose \
                       -DVPIC_USE_VTUNE_OFF \
                       -I$VTUNE_AMPLIFIER_XE_2017_DIR/include" \
    ..
  make -j $NJ VERBOSE=1
fi
