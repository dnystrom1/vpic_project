#!/bin/bash

test_home=../../../../../VPIC_Test_Decks/reconnection/reconnection_1

#######################################################################
# Set run parameters.

np=$1
nnodes=$2
nppn=$3
ntpp=$4
nppc=$5
nstep=$6
nrestart=$7
size=$8

#######################################################################
# Set some parameters that we don't want to vary right now.

io_type='none'
field_io_format='band_interleave'
num_turnstiles='2048'
field_interval='1500'
particle_interval='1500'
mi_me='100'
ion_sort_interval='100'
eon_sort_interval='25'
energies_interval='-10'

#######################################################################
# Configure use of a turnstile for the native VPIC parallel IO support.

if echo $io_type | grep -q "pio"
then
    begin_turnstile='BEGIN_TURNSTILE(NUM_TURNSTILES) {'
    end_turnstile='} END_TURNSTILE;'
else
    begin_turnstile=''
    end_turnstile=''
fi

#######################################################################
# Edit the input file to use our configurable input parameters.

update='
s/REPLACE_begin_turnstile/'${begin_turnstile}'/
s/REPLACE_end_turnstile/'${end_turnstile}'/
s/REPLACE_Ly_scale/'$((10#${nnodes}))'/
s/REPLACE_topology_y_scale/'$((10#${nnodes}))'/
s/REPLACE_ny_scale/'$((10#${nnodes}))'/
s/REPLACE_nppc/'${nppc}'/
s/REPLACE_nstep/'${nstep}'/
s/REPLACE_nrestart/'${nrestart}'/
s/REPLACE_field_io_format/'${field_io_format}'/
s/REPLACE_num_turnstiles/'${num_turnstiles}'/
s/REPLACE_field_interval/'${field_interval}'/
s/REPLACE_particle_interval/'${particle_interval}'/
s/REPLACE_io_type/'${io_type}'/
s/REPLACE_mi_me/'${mi_me}'/
s/REPLACE_ion_sort_interval/'${ion_sort_interval}'/
s/REPLACE_eon_sort_interval/'${eon_sort_interval}'/
s/REPLACE_energies_interval/'${energies_interval}'/
'

cat ${test_home}/reconnection_np_${np}.template.cxx | sed -e "$update" >& reconnection_${size}_nn_${nnodes}_nppn_${nppn}_ntpp_${ntpp}.cxx
